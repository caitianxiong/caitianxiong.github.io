<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Kubernetes,Ingress,Nginx," />





  <link rel="alternate" href="/atom.xml" title="Have A Nice Day" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/images/leon.jpg?v=5.0.1" />






<meta name="description" content="结合项目上生产使用经验，研发给出的参数调优建议。本篇仅作记录，及做一个分享，版权归我的好兄弟@董琪。">
<meta property="og:type" content="article">
<meta property="og:title" content="Ingress参数优化">
<meta property="og:url" content="https://caitianxiong.com/2018/05/04/Ingress参数优化/index.html">
<meta property="og:site_name" content="Have A Nice Day">
<meta property="og:description" content="结合项目上生产使用经验，研发给出的参数调优建议。本篇仅作记录，及做一个分享，版权归我的好兄弟@董琪。">
<meta property="og:updated_time" content="2020-01-17T14:16:56.612Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ingress参数优化">
<meta name="twitter:description" content="结合项目上生产使用经验，研发给出的参数调优建议。本篇仅作记录，及做一个分享，版权归我的好兄弟@董琪。">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="https://caitianxiong.com/2018/05/04/Ingress参数优化/"/>

  <title> Ingress参数优化 | Have A Nice Day </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?a85e033404111b6034dd3aa973708f20";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Have A Nice Day</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Ingress参数优化
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-05-04T00:00:00+08:00" content="2018-05-04">
              2018-05-04
            </time>
          </span>

          

          
            
          

          

          
          
             <span id="/2018/05/04/Ingress参数优化/" class="leancloud_visitors" data-flag-title="Ingress参数优化">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>结合项目上生产使用经验，研发给出的参数调优建议。本篇仅作记录，及做一个分享，版权归我的好兄弟@董琪。<br><a id="more"></a></p>
<h1 id="内核优化"><a href="#内核优化" class="headerlink" title="内核优化"></a>内核优化</h1><h2 id="kernel-pid-max-600000"><a href="#kernel-pid-max-600000" class="headerlink" title="kernel.pid_max = 600000"></a>kernel.pid_max = 600000</h2><p>之前江苏环境 nginx 产生大量 close-wait 就是由于该参数设置过小，具体参考附件【BCLinux系统出现大量CLOSE_WAIT连接问题分析报告】</p>
<h2 id="fs-aio-max-nr-1065535"><a href="#fs-aio-max-nr-1065535" class="headerlink" title="fs.aio-max-nr = 1065535"></a>fs.aio-max-nr = 1065535</h2><p>北京环境 nginx 报错 io_setup() failed (11: resource temporarily unavailable)<br>由于 nginx 使用 linux 原生的异步 io，所以当 <code>/proc/sys/fs/aio-max-nr</code> （默认 65535） 过小时，出现以上错误。<code>/proc/sys/fs/aio-nr</code> 用于显示当前 <code>aio</code> 请求数。<br>解决办法：设置 <code>aio-max-nr</code> 为 1048576</p>
<h2 id="net-ipv4-tcp-tw-recycle-1"><a href="#net-ipv4-tcp-tw-recycle-1" class="headerlink" title="net.ipv4.tcp_tw_recycle=1"></a>net.ipv4.tcp_tw_recycle=1</h2><p>表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。</p>
<h2 id="net-ipv4-tcp-tw-reuse-1"><a href="#net-ipv4-tcp-tw-reuse-1" class="headerlink" title="net.ipv4.tcp_tw_reuse=1"></a>net.ipv4.tcp_tw_reuse=1</h2><p>表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；</p>
<h2 id="net-ipv4-tcp-timestamps-1"><a href="#net-ipv4-tcp-timestamps-1" class="headerlink" title="net.ipv4.tcp_timestamps=1"></a>net.ipv4.tcp_timestamps=1</h2><p>TCP时间戳（会在TCP包头增加12个字节），以一种比重发超时更精确的方法（参考RFC 1323）来启用对RTT 的计算，为实现更好的性能应该启用这个选项。<br>更重要的是，启用TCP时间戳可以防止回绕，因为TCP头的序列号字段定义为32字节，在高速网络环境里，TCP序列号容易产生回绕，既接收者最新收到分片的序列号比之前到达的序列号要小，导致不正确的丢包行为。<br>在1Gbps网络带宽环境中，可能会在17秒内会发生TCP序列号回绕，而在10Gbps网络带宽环境中，发生回绕的时间甚至缩短到1.7秒，所以在高速网络环境里，必须要开启TCP时间戳选项。<br>首先确认TCP时间戳是否启用：<br><code>sysctl net.ipv4.tcp_timestamps</code><br><code>net.ipv4.tcp_timestamps = 0</code><br>如果没有启用该项，建议开启：<br><code>sysctl -w net.ipv4.tcp_timestamps=1</code></p>
<h2 id="net-ipv4-tcp-fin-timeout-20"><a href="#net-ipv4-tcp-fin-timeout-20" class="headerlink" title="net.ipv4.tcp_fin_timeout=20"></a>net.ipv4.tcp_fin_timeout=20</h2><p>TCP FIN Timeout定义了对于本端断开的socket连接，TCP保持在FIN-WAIT-2状态的时间（秒），而对方可能会断开连接或一直不结束连接或不可预料的进程死亡。其默认值为60有点偏高，建议调整该值至20或者30，以便TCP连接尽快关闭并释放资源：<br><code>sysctl -w net.ipv4.tcp_fin_timeout=20</code></p>
<h2 id="net-core-somaxconn-65535"><a href="#net-core-somaxconn-65535" class="headerlink" title="net.core.somaxconn=65535"></a>net.core.somaxconn=65535</h2><p>全连接队列长度，对应 listen 函数中 backlog （监听队列的长度）的大小，和 <code>tcp_max_syn_backlog</code> 定义的半连接队列相对应</p>
<h2 id="net-ipv4-tcp-max-syn-backlog-65535"><a href="#net-ipv4-tcp-max-syn-backlog-65535" class="headerlink" title="net.ipv4.tcp_max_syn_backlog=65535"></a>net.ipv4.tcp_max_syn_backlog=65535</h2><p>记录的那些尚未收到客户端确认信息的连接请求的最大值。对于超过128M内存的系统而言，缺省值是1024，低于128M小内存的系统则是128。<br>SYN Flood攻击利用TCP协议散布握手的缺陷，伪造虚假源IP地址发送大量TCP-SYN半打开连接到目标系统，最终导致目标系统Socket队列资源耗尽而无法接受新的连接。为了应付这种攻击，现代Unix系统中普遍采用多连接队列处理的方式来缓冲(而不是解决)这种攻击，是用一个基本队列处理正常的完全连接应用(Connect()和Accept() )，是用另一个队列单独存放半打开连接。<br>这种双队列处理方式和其他一些系统内核措施(例如Syn-Cookies/Caches)联合应用时，能够比较有效的缓解小规模的SYN Flood攻击(事实证明<1000p s)加大syn队列长度可以容纳更多等待连接的网络连接数，一般遭受syn="" flood攻击的网站，都存在大量syn_recv状态，所以调大tcp_max_syn_backlog值能增加抵抗syn攻击的能力。="" 如果服务器端向客户端发送syn＋ack后，客户端不返回ack，则服务器保持半连接(syn_recv)状态：="" <figure="" class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">linux # netstat -np | grep SYN_RECV</div><div class="line">tcp 0 0 0.0.0.0:9999 127.0.0.0.1:5334 SYN_RECV -</div></pre></td></tr></table></1000p></p>
<p>若队列中的连接均处于半连接状态，服务器将不能处理正常的请求，syn泛洪攻击(syn flood)就是利用这个特点完成DoS(拒绝服务攻击)。<br>当连接数超过队列长度backlog时，超出的连接也保持为半连接状态，直到数量达到内核参数tcp_max_syn_backlog值，超出该值的连接请求将被丢弃：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">linux # sysctl -a | grep tcp_max_syn</div><div class="line">net.ipv4.tcp_max_syn_backlog = 1024</div></pre></td></tr></table></figure></p>
<h2 id="net-ipv4-tcp-syncookies-0"><a href="#net-ipv4-tcp-syncookies-0" class="headerlink" title="net.ipv4.tcp_syncookies = 0"></a>net.ipv4.tcp_syncookies = 0</h2><p>apache ab压力测试报错（apr_socket_recv: Connection reset by peer (104)）<br>查看应用服务器和数据库均未报错，连接被重置，apr_socket_recv这个是操作系统内核的一个参数，在高并发的情况下，内核会认为系统受到了SYN flood攻击，会发送cookies（possible SYN flooding on port 80. Sending cookies），这样会减慢影响请求的速度，所以在应用服务武器上设置下这个参数为0禁用系统保护就可以进行大并发测试了：</p>
<h2 id="net-core-netdev-max-backlog-300000"><a href="#net-core-netdev-max-backlog-300000" class="headerlink" title="net.core.netdev_max_backlog=300000"></a>net.core.netdev_max_backlog=300000</h2><p>在内核协议栈接收处理数据包之前，数据默认是存放在内核队列里的。<code>netdev_max_backlog</code> 定义了在当接口收到数据包的速率快于内核处理速率时，允许发送到队列数据包的最大数目，对于高负载的网络其默认值显然是不够的。<br>首先查看netdev_max_backlog的默认值：<br><code>sysctl net.core.netdev_max_backlog</code><br><code>net.core. netdev_max_backlog = 1000</code><br>对于10Gbps带宽的网络环境，建议调整其值如下：<br><code>sysctl -w net.core.netdev_max_backlog=300000</code></p>
<h2 id="net-ipv4-tcp-keepalive-time-10"><a href="#net-ipv4-tcp-keepalive-time-10" class="headerlink" title="net.ipv4.tcp_keepalive_time=10"></a>net.ipv4.tcp_keepalive_time=10</h2><p>TCP发送keepalive探测消息的间隔时间（秒），用于确认TCP连接是否有效。</p>
<h2 id="net-ipv4-tcp-keepalive-probes-2"><a href="#net-ipv4-tcp-keepalive-probes-2" class="headerlink" title="net.ipv4.tcp_keepalive_probes=2"></a>net.ipv4.tcp_keepalive_probes=2</h2><p>在认定TCP连接失效之前，最多发送多少个keepalive探测消息。</p>
<h2 id="net-ipv4-tcp-keepalive-intvl-2"><a href="#net-ipv4-tcp-keepalive-intvl-2" class="headerlink" title="net.ipv4.tcp_keepalive_intvl=2"></a>net.ipv4.tcp_keepalive_intvl=2</h2><p>探测消息未获得响应时，重发该消息的间隔时间（秒）。</p>
<h2 id="net-ipv4-tcp-mem-94500000-915000000-927000000"><a href="#net-ipv4-tcp-mem-94500000-915000000-927000000" class="headerlink" title="net.ipv4.tcp_mem=94500000 915000000 927000000"></a>net.ipv4.tcp_mem=94500000 915000000 927000000</h2><p>除了用于缓冲收发数据包的 tcp_wmem 和 tcp_rmem，对于每个socket，内核还要分配一些数据结构用于保持连接状态，内核对tcp层可使用的内存大小进行了限制，所以有了 tcp_mem：<br>tcp_mem 有 3 个 INTEGER 变量：low, pressure, high</p>
<ul>
<li>low：当 TCP 使用了低于该值的内存页面数时，TCP 没有内存压力，TCP 不会考虑释放内存。(理<br>想情况下，这个值应与指定给 tcp_wmem 的第 2 个值相匹配。这第 2 个值表明，最大页面大小乘以最大<br>并发请求数除以页大小 (131072*300/4096)</li>
<li>pressure：当 TCP 使用了超过该值的内存页面数量时，TCP 试图稳定其内存使用，进入 pressure<br>模式，当内存消耗低于 low 值时则退出 pressure 状态。(理想情况下这个值应该是 TCP 可以使用的总缓<br>冲区大小的最大值(204800*300/4096)</li>
<li>high：允许所有 TCP Sockets 用于排队缓冲数据报的页面量。如果超过这个值，TCP 连接将被拒绝，<br>这就是为什么不要令其过于保守(512000*300/4096)的原因了。在这种情况下，提供的价值很大，它能<br>处理很多连接，是所预期的 2.5 倍；或者使现有连接能够传输 2.5 倍的数据。<br>一般情况下这些值是在系统启动时根据系统内存数量计算得到的。<blockquote>
<p>以上值以页为单位，分别对应最小值、压力值和最大值，并在系统启动、tcp栈初始化时根据内存总量设定。通过proc提供的接口，我们可以查到tcp已用的内存页数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt;linux # cat /proc/net/sockstat</div><div class="line">&gt;sockets : used 91</div><div class="line">&gt;TCP : inuse 8 orphan 0 tw 11 alloc 13 mem 2</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<h2 id="net-ipv4-tcp-rmem-4096-87380-134217728"><a href="#net-ipv4-tcp-rmem-4096-87380-134217728" class="headerlink" title="net.ipv4.tcp_rmem=4096 87380 134217728"></a>net.ipv4.tcp_rmem=4096 87380 134217728</h2><p>内核为tcp socket预留的用于读取数据包的缓冲区大小<br>TCP 的性能取决于几个方面的因素。两个最重要的因素是链接带宽（link bandwidth）（报文在网络上传输的速率）和 往返时间（round-trip time） 或 RTT（发送报文与接收到另一端的响应之间的延时）。这两个值确定了称为 Bandwidth Delay Product（BDP）的内容。<br>BDP 给出了一种简单的方法来计算理论上最优的 TCP socket 缓冲区大小（其中保存了排队等待传输和等待应用程序接收的数据）。如果缓冲区太小，那么 TCP 窗口就不能完全打开，这会对性能造成限制。如果缓冲区太大，那么宝贵的内存资源就会造成浪费。如果您设置的缓冲区大小正好合适，那么就可以完全利用可用的带宽，计算公式如下：<br>BDP = link_bandwidth <em> RTT<br>RTT的值可以通过ping获取到一个平均值，例如，在10Gbps宽带网络里，如果RTT值为100ms，那么BDP就是：<br>10Gps </em> 100ms = (10<em>2^30)bits </em> 0.1s / 8 = 134217728 Bytes.<br>TCP套接字缓存参数主要包括：<code>net.ipv4.tcp_rmem</code>，<code>net.ipv4.tcp_wmem</code><br>这些参数值主要包括3个字段，分别代表最小、默认、最大的TCP接收和发送缓存大小。在TCP缓存成为性能瓶颈的时候，建议调整该参数的最大发送缓存大小至BDP的值，例如10Gbps业务环境的配置参考如下：<br><code>sysctl -w net.ipv4.tcp_rmem=&quot;40960 873800 1342177280&quot;</code><br><code>sysctl -w net.ipv4.tcp_wmem=&quot;40960 655360 1342177280&quot;</code></p>
<h2 id="net-ipv4-tcp-wmem-4096-87380-134217728"><a href="#net-ipv4-tcp-wmem-4096-87380-134217728" class="headerlink" title="net.ipv4.tcp_wmem=4096 87380 134217728"></a>net.ipv4.tcp_wmem=4096 87380 134217728</h2><p>如上</p>
<h2 id="net-core-wmem-default-68388608"><a href="#net-core-wmem-default-68388608" class="headerlink" title="net.core.wmem_default = 68388608"></a>net.core.wmem_default = 68388608</h2><p>该参数指定了发送套接字缓冲区大小的缺省值(以字节为单位)</p>
<h2 id="net-core-rmem-default-68388608"><a href="#net-core-rmem-default-68388608" class="headerlink" title="net.core.rmem_default = 68388608"></a>net.core.rmem_default = 68388608</h2><p>该参数指定了接收套接字缓冲区大小的缺省值(以字节为单位)</p>
<h2 id="net-core-rmem-max-1116777216"><a href="#net-core-rmem-max-1116777216" class="headerlink" title="net.core.rmem_max = 1116777216"></a>net.core.rmem_max = 1116777216</h2><p>该参数指定了接收套接字缓冲区大小的最大值(以字节为单位)</p>
<h2 id="net-core-wmem-max-1116777216"><a href="#net-core-wmem-max-1116777216" class="headerlink" title="net.core.wmem_max = 1116777216"></a>net.core.wmem_max = 1116777216</h2><p>该参数指定了发送套接字缓冲区大小的最大值(以字节为单位)</p>
<h2 id="net-ipv4-tcp-sack-0"><a href="#net-ipv4-tcp-sack-0" class="headerlink" title="net.ipv4.tcp_sack = 0"></a>net.ipv4.tcp_sack = 0</h2><p>TCP SACK启用有选择的应答（1表示启用），通过有选择地应答乱序接收到的报文来提供网络利用率，让发送者只发送丢失的报文段，但是有研究表明如果启用该项会增加对CPU的占用，降低TCP连接的整体效率。除非在高延迟或者高丢包率的场景下需要启用该项，而对于高负载网络业务环境下建议关闭SACK，调整命令如下：<br><code>sysctl -w net.ipv4.tcp_sack=0</code><br><code>net.ipv4.tcp_sack = 0</code></p>
<h2 id="net-ipv4-tcp-max-tw-buckets-65535"><a href="#net-ipv4-tcp-max-tw-buckets-65535" class="headerlink" title="net.ipv4.tcp_max_tw_buckets=65535"></a>net.ipv4.tcp_max_tw_buckets=65535</h2><p>表示系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。默认为180000，改为5000。</p>
<h2 id="net-ipv4-tcp-max-orphans-32768"><a href="#net-ipv4-tcp-max-orphans-32768" class="headerlink" title="net.ipv4.tcp_max_orphans=32768"></a>net.ipv4.tcp_max_orphans=32768</h2><p>系统所能处理不属于任何进程的TCP sockets最大数量。假如超过这个数量﹐那么不属于任何进程的连接会被立即reset，并同时显示警告信息。之所以要设定这个限制﹐纯粹为了抵御那些简单的DoS攻击﹐千万不要依赖这个或是人为的降低这个限制</p>
<h2 id="net-ipv4-tcp-synack-retries-2"><a href="#net-ipv4-tcp-synack-retries-2" class="headerlink" title="net.ipv4.tcp_synack_retries = 2"></a>net.ipv4.tcp_synack_retries = 2</h2><p>对于远端的连接请求 SYN，内核会发送 SYN＋ACK 数据报，以确认收到上一个 SYN 连接请求包。这是所谓的三次握手(threeway handshake)机制的第二个步骤。这里决定内核在放弃连接之前所送出的SYN+ACK 数目。不应该大于 255，默认值是 5，对应于 180 秒左右时间。(可以根据 tcp_syn_retries 来决定这个值)</p>
<h2 id="net-ipv4-tcp-syn-retries-2"><a href="#net-ipv4-tcp-syn-retries-2" class="headerlink" title="net.ipv4.tcp_syn_retries = 2"></a>net.ipv4.tcp_syn_retries = 2</h2><p>对于一个新建连接，内核要发送多少个 SYN 连接请求才决定放弃。不应该大于 255，默认值是 5，对应于 180 秒左右时间。(对于大负载而物理通信良好的网络而言,这个值偏高,可修改为 2.这个值仅仅是针对对外的连接,对进来的连接,是由 tcp_retries1 决定的)</p>
<h2 id="net-ipv4-ip-forward-1"><a href="#net-ipv4-ip-forward-1" class="headerlink" title="net.ipv4.ip_forward=1"></a>net.ipv4.ip_forward=1</h2><p>ip地址分公有地址和私有地址，public address是由INIC(internet network information center)负责，这些ip地址分配给注册并向INIC提出申请的组织机构。通过它访问internet.private address是属于非注册地址，专门为组织内部使用，private ip address是不可能直接用来跟WAN通信的，要么利用帧来通信（FRE帧中继，HDLC,PPP）,要么需要路由的NAT功能把私有地址转换为一个公有ip!<br>选择一台电脑（有两个网卡或者用单网卡然后用软件虚拟多一个网卡）充当网关，一个网卡(eth0)连接外网ISP，另一网卡(eth1)连接内网(即局域网)。局域网内的ip地址都是私用地址，只能在内部使用，在公网上是不可见的，所以局域网电脑要上网必须修改ip，这就是网关的工作。<br>工作原理：<br>内网主机向公网发送数据包时，由于目的主机跟源主机不在同一网段，所以数据包暂时发往内网默认网关处理，而本网段的主机对此数据包不做任何回应。由于源主机ip是私有的，禁止在公网使用，所以必须将数据包的源发送地址修改成公网上的可用ip，这就是网关收到数据包之后首先要做的工作–ip转换。然后网关再把数据包发往目的主机。目的主机收到数据包之后，只认为这是网关发送的请求，并不知道内网主机的存在，也没必要知道，目的主机处理完请求，把回应信息发还给网关。网关收到后，将目的主机发还的数据包的目的ip地址修改为发出请求的内网主机的ip地址，并将其发给内网主机。这就是网关的第二个工作–数据包的路由转发。内网的主机只要查看数据包的目的ip与发送请求的源主机ip地址相同，就会回应，这就完成了一次请求。<br>出于安全考虑，Linux系统默认是禁止数据包转发的。所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包，根据数据包的目的ip地址将包发往本机另一网卡，该网卡根据路由表继续发送数据包。这通常就是路由器所要实现的功能。<br>配置Linux系统的ip转发功能，首先保证硬件连通，然后打开系统的转发功能<br>less /proc/sys/net/ipv4/ip_forward，该文件内容为0，表示禁止数据包转发，1表示允许，将其修改为1。可使用命令echo “1” &gt; /proc/sys/net/ipv4/ip_forward 修改文件内容，重启网络服务或主机后效果不再。若要其自动执行，可将命令echo “1” &gt; /proc/sys/net/ipv4/ip_forward 写入脚本/etc/rc.d/rc.local 或者 在/etc/sysconfig/network脚本中添加 FORWARD_IPV4=”YES”<br><a href="http://www.cnblogs.com/jackhub/p/3575879.html" target="_blank" rel="external">http://www.cnblogs.com/jackhub/p/3575879.html</a></p>
<h2 id="net-ipv6-conf-all-disable-ipv6-1"><a href="#net-ipv6-conf-all-disable-ipv6-1" class="headerlink" title="net.ipv6.conf.all.disable_ipv6=1"></a>net.ipv6.conf.all.disable_ipv6=1</h2><h2 id="net-ipv6-conf-default-disable-ipv6-1"><a href="#net-ipv6-conf-default-disable-ipv6-1" class="headerlink" title="net.ipv6.conf.default.disable_ipv6=1"></a>net.ipv6.conf.default.disable_ipv6=1</h2><h2 id="net-ipv4-ip-forward-1-1"><a href="#net-ipv4-ip-forward-1-1" class="headerlink" title="net.ipv4.ip_forward=1"></a>net.ipv4.ip_forward=1</h2><h2 id="net-ipv4-ip-local-port-range-1024-65000"><a href="#net-ipv4-ip-local-port-range-1024-65000" class="headerlink" title="net.ipv4.ip_local_port_range = 1024 65000"></a>net.ipv4.ip_local_port_range = 1024 65000</h2><h1 id="nginx-部分配置优化"><a href="#nginx-部分配置优化" class="headerlink" title="nginx 部分配置优化"></a>nginx 部分配置优化</h1><ul>
<li>worker_processes：子进程数优化</li>
<li>worker_rlimit_nofile：进程打开的最大文件描述符优化</li>
<li>multi_accept：优化 worker 进程可以一次接收监听队列里所有请求</li>
<li>worker_connections：优化 worker 进程可以处理的最大请求数</li>
<li>use epoll：使用 epoll 事件驱动模型</li>
<li>sendfile：开启高效文件传输模式</li>
<li>aio：使用异步 io 优化</li>
<li>tcp_nopush：长连接时生效</li>
<li>tcp_nodelay：配合 sendfile 使用</li>
<li>reset_timedout_connection：关闭不响应的客户端连接</li>
<li>keepalive_timeout：优化 keepalive 长连接</li>
<li>keepalive_requests：优化每个长连接上可以服务的最大请求数量</li>
<li>client_body_buffer_size 系列参数的优化，优化客户端请求的缓存及body</li>
<li>gzip：压缩数据，提高传输速率</li>
<li>upstream 中的 keepalive：优化 nginx 与上游服务器间的空闲连接</li>
<li>proxy_connect_timeout 系列：优化 nginx 与上游服务器间的超时</li>
<li>proxy_buffers 系列：上游服务器返回数据给 nginx 时，nginx 缓存数据后一起发送，提高效率。</li>
</ul>
<h1 id="nginx-排除总结"><a href="#nginx-排除总结" class="headerlink" title="nginx 排除总结"></a>nginx 排除总结</h1><h2 id="io-setup-failed-11-resource-temporarily-unavailable"><a href="#io-setup-failed-11-resource-temporarily-unavailable" class="headerlink" title="io_setup() failed (11: resource temporarily unavailable)"></a>io_setup() failed (11: resource temporarily unavailable)</h2><p>北京环境 nginx 报错 io_setup() failed (11: resource temporarily unavailable)<br>由于 nginx 使用 linux 原生的异步 io，所以当 <code>/proc/sys/fs/aio-max-nr</code> （默认 65535） 过小时，出现以上错误。<code>/proc/sys/fs/aio-nr</code> 用于显示当前 <code>aio</code> 请求数。<br>解决办法：设置 <code>aio-max-nr</code> 为 1048576</p>
<h2 id="nginx-返回-500-错误"><a href="#nginx-返回-500-错误" class="headerlink" title="nginx 返回 500 错误"></a>nginx 返回 500 错误</h2><p>这是因为 post 请求体中的数据太多了，可以通过设置 <code>client_body_buffer_size</code>，<code>client_max_body_size</code> 等参数搞定。</p>
<blockquote>
<p>同时针对post请求还需要注意参数(client_body_in_single_buffer)的配置，如果不打开这个选项当请求串大于client_body_buffer_size大小时，需要手动去读取存储在磁盘的请求，这里需要注意的是存入磁盘的请求是一个完整的请求并不是大于client_body_buffer_size的部分</p>
</blockquote>
<p>解决办法如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">client_header_buffer_size 4K;</div><div class="line">large_client_header_buffers 4 8k;</div><div class="line">client_body_buffer_size 60k;</div><div class="line">client_max_body_size 2m;</div><div class="line">client_body_in_single_buffer on;</div></pre></td></tr></table></figure></p>
<h2 id="nginx-css-等静态文件找不到"><a href="#nginx-css-等静态文件找不到" class="headerlink" title="nginx css 等静态文件找不到"></a>nginx css 等静态文件找不到</h2><p>解决办法：<br>nginx 中配置 <code>proxy_set_header Host $http_host;</code> ，<code>$host</code> 和 <code>$http_host</code> 的区别是后者带端口</p>
<p>HTTP header 中的 X_Forward_For 表示该条 http 请求是由谁发起的。如果反向代理服务器不重写该请求头的话，那么后端真实 web 服务器在处理时会认为所有的请求都来自反向代理服务器。如果后端 web 服务器有防攻击策略的话，那么反向代理服务器对应的 ip 地址就会被封掉。因此，在配置用作反向代理的 nginx 时，一般会增加以下两条配置修改 http 的请求头：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">proxy_set_header Host $http_host;</div><div class="line">proxy_set_header X-Forward-For $remote_addr;</div></pre></td></tr></table></figure></p>
<p>这里，<code>$http_host</code> 和 <code>$remote_addr</code>都是 nginx 的导出变量，可以在配置文件中直接使用。如果 Host 没有出现在 HTTP header 中，则 <code>$http_host</code> 的值为空，而 <code>$host</code> 和 <code>$http_host</code> 同样表示请求头中的 Host 字段，但若 Host 字段不存在，则以实际处理的虚拟主机 server 的 server_name 替代。因此一般而言，会用 <code>$host</code> 代替 <code>$http_host</code> 变量（如下），从而避免 http 请求中丢失 Host 头部的情况下 Host 不被重写的失误。</p>
<p>X-real-ip 和 X-Forwarded-For 的区别</p>
<h2 id="nginx-江苏环境返回真实-IP"><a href="#nginx-江苏环境返回真实-IP" class="headerlink" title="nginx 江苏环境返回真实 IP"></a>nginx 江苏环境返回真实 IP</h2><p>在一级负载均衡的 nginx location 中添加 <code>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</code></p>
<p>此时应用可以从 <code>X-Forwarded-For</code> Header 中获取真实 IP</p>
<h2 id="swagger-跨域问题"><a href="#swagger-跨域问题" class="headerlink" title="swagger 跨域问题"></a>swagger 跨域问题</h2><p>用 nignx 做反向代理，在 <code>locaion</code> 中添加 <code>add_header Access-Control-Allow-Origin *;</code> 即可。</p>
<blockquote>
<p>注意这里使用了 <code>add_header</code> 表示在 response 返回中添加 header</p>
</blockquote>
<p>参考文献：</p>
<p><a href="http://www.yunweipai.com/archives/9381.html" target="_blank" rel="external">http://www.yunweipai.com/archives/9381.html</a></p>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="external">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS</a></p>
<h2 id="nginx-静态缓存问题"><a href="#nginx-静态缓存问题" class="headerlink" title="nginx 静态缓存问题"></a>nginx 静态缓存问题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">http &#123;</div><div class="line">proxy_cache_path /tmp/nginx levels=1:2 keys_zone=my_zone:10m inactive=60m;</div><div class="line">proxy_cache_valid 200 304 302 24h;</div><div class="line"># proxy_cache_key &quot;$scheme$request_method$host$request_uri&quot;;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">server_name _ ;</div><div class="line"></div><div class="line">listen 30000;</div><div class="line"></div><div class="line">location /index &#123;</div><div class="line">proxy_cache my_zone;</div><div class="line">add_header X-Proxy-Cache $upstream_cache_status;</div><div class="line"></div><div class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</div><div class="line">proxy_pass http://10.142.21.251:36000;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>先说下 proxy_cache_path 中的参数：</p>
<ul>
<li><p>/tmp/nginx 是缓存存放的路径</p>
</li>
<li><p>levels=1:2 是用来指定缓存文件夹的级数，该例中表示建立2级目录，例如资源路径进行hash处理，得到e0bd86606797639426a92306b1b98ad9，再hash值最后1位(9)拿出建一个目录，然后再把9前面的2位(ad)拿来建一个目录, 那么缓存文件的路径就是/tmp/nginx/9/d/e0bd86606797639426a92306b1b98ad9。</p>
</li>
<li><p>keys_zone=cache_zone:10m 其中 cache_zone 表示共享池的名称，随便起个名字，10m表示10兆，这个共享池的大小。在共享内存中设置一块存储区域来存放缓存的key和metadata（类似使用次数），这样nginx可以快速判断一个request是否命中或者未命中缓存，1m可以存储8000个key，10m可以存储80000个key；</p>
</li>
<li><p>inactive=1d 表示指定时间内缓存的数据如果没有被请求则会被删除。</p>
</li>
<li><p>max_size=100m 最大cache空间，如果不指定，会使用掉所有disk space，当达到配额后，会删除最少使用的cache文件；</p>
</li>
<li><p>proxy_cache cache_zone 用来指定用哪个 keys_zone 名字，因为 proxy_cache_path 可以使用多次，指定多个目录。</p>
</li>
<li><p>proxy_cache_key \$scheme\$host$request_uri; 用来指定生成hash的url地址的格式。他会根据这个key映射成一个hash值，然后存入到本地文件。</p>
</li>
<li><p>proxy_cache_valid any 10s; 表示对所有的状态码设置缓存的有效时间为 10s。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">proxy_cache_valid 200 302 10m;</div><div class="line">proxy_cache_valid 301 1h;</div><div class="line">proxy_cache_valid any 1m; #所有的状态都缓存1小时</div></pre></td></tr></table></figure>
<h2 id="close-wait-问题"><a href="#close-wait-问题" class="headerlink" title="close-wait 问题"></a>close-wait 问题</h2><p>江苏环境产生大量 close-wait ，由于 pid 数量超过内核限制，导致 nginx 工作进程无法创建线程。解决办法：调整内核 pid_max 参数</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Kubernetes/" rel="tag">#Kubernetes</a>
          
            <a href="/tags/Ingress/" rel="tag">#Ingress</a>
          
            <a href="/tags/Nginx/" rel="tag">#Nginx</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/01/05/部署K8s集群/" rel="next" title="部署K8s集群">
                <i class="fa fa-chevron-left"></i> 部署K8s集群
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/08/01/K8s对接GlusterFS/" rel="prev" title="K8s对接GlusterFS">
                K8s对接GlusterFS <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/leon.jpg"
               alt="Leon" />
          <p class="site-author-name" itemprop="name">Leon</p>
          <p class="site-description motion-element" itemprop="description">人生很长，什么都有可能。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">19</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/caitianxiong" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/darkhacker" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-zhihu"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友链
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://fullstack.love/" title="醉己斋" target="_blank">醉己斋</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://www.blog.szcoder.com/" title="Neo Blog" target="_blank">Neo Blog</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://unkownarea.com/" title="未知地界" target="_blank">未知地界</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://tcztzy.github.io/" title="Tcztzy" target="_blank">Tcztzy</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#内核优化"><span class="nav-text">内核优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#kernel-pid-max-600000"><span class="nav-text">kernel.pid_max = 600000</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fs-aio-max-nr-1065535"><span class="nav-text">fs.aio-max-nr = 1065535</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-tw-recycle-1"><span class="nav-text">net.ipv4.tcp_tw_recycle=1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-tw-reuse-1"><span class="nav-text">net.ipv4.tcp_tw_reuse=1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-timestamps-1"><span class="nav-text">net.ipv4.tcp_timestamps=1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-fin-timeout-20"><span class="nav-text">net.ipv4.tcp_fin_timeout=20</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-core-somaxconn-65535"><span class="nav-text">net.core.somaxconn=65535</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-max-syn-backlog-65535"><span class="nav-text">net.ipv4.tcp_max_syn_backlog=65535</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-syncookies-0"><span class="nav-text">net.ipv4.tcp_syncookies = 0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-core-netdev-max-backlog-300000"><span class="nav-text">net.core.netdev_max_backlog=300000</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-keepalive-time-10"><span class="nav-text">net.ipv4.tcp_keepalive_time=10</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-keepalive-probes-2"><span class="nav-text">net.ipv4.tcp_keepalive_probes=2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-keepalive-intvl-2"><span class="nav-text">net.ipv4.tcp_keepalive_intvl=2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-mem-94500000-915000000-927000000"><span class="nav-text">net.ipv4.tcp_mem=94500000 915000000 927000000</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-rmem-4096-87380-134217728"><span class="nav-text">net.ipv4.tcp_rmem=4096 87380 134217728</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-wmem-4096-87380-134217728"><span class="nav-text">net.ipv4.tcp_wmem=4096 87380 134217728</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-core-wmem-default-68388608"><span class="nav-text">net.core.wmem_default = 68388608</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-core-rmem-default-68388608"><span class="nav-text">net.core.rmem_default = 68388608</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-core-rmem-max-1116777216"><span class="nav-text">net.core.rmem_max = 1116777216</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-core-wmem-max-1116777216"><span class="nav-text">net.core.wmem_max = 1116777216</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-sack-0"><span class="nav-text">net.ipv4.tcp_sack = 0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-max-tw-buckets-65535"><span class="nav-text">net.ipv4.tcp_max_tw_buckets=65535</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-max-orphans-32768"><span class="nav-text">net.ipv4.tcp_max_orphans=32768</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-synack-retries-2"><span class="nav-text">net.ipv4.tcp_synack_retries = 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-tcp-syn-retries-2"><span class="nav-text">net.ipv4.tcp_syn_retries = 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-ip-forward-1"><span class="nav-text">net.ipv4.ip_forward=1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv6-conf-all-disable-ipv6-1"><span class="nav-text">net.ipv6.conf.all.disable_ipv6=1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv6-conf-default-disable-ipv6-1"><span class="nav-text">net.ipv6.conf.default.disable_ipv6=1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-ip-forward-1-1"><span class="nav-text">net.ipv4.ip_forward=1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#net-ipv4-ip-local-port-range-1024-65000"><span class="nav-text">net.ipv4.ip_local_port_range = 1024 65000</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx-部分配置优化"><span class="nav-text">nginx 部分配置优化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx-排除总结"><span class="nav-text">nginx 排除总结</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#io-setup-failed-11-resource-temporarily-unavailable"><span class="nav-text">io_setup() failed (11: resource temporarily unavailable)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx-返回-500-错误"><span class="nav-text">nginx 返回 500 错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx-css-等静态文件找不到"><span class="nav-text">nginx css 等静态文件找不到</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx-江苏环境返回真实-IP"><span class="nav-text">nginx 江苏环境返回真实 IP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#swagger-跨域问题"><span class="nav-text">swagger 跨域问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx-静态缓存问题"><span class="nav-text">nginx 静态缓存问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#close-wait-问题"><span class="nav-text">close-wait 问题</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Leon</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("YIJ5gxbEG1DDJrtEsLB5yzeE-gzGzoHsz", "q1UAnxXkMVrNVaH2FSq7DATV");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
